<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Selection</title>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script defer src="script.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="top-right-buttons">
        <button id="save">Enregistrer</button>
        <button id="print">Imprimer</button>
    </div>
    <h2>Sélectionnez les QR Codes</h2>
    <div class="qr-container">
        <select id="qr-select" multiple></select>
        <div id="qr-display"></div>
    </div>
    <div class="button-container">
        <button id="add-qr">Ajouter QR Code</button>
        <button id="remove-qr">Supprimer QR Code</button>
        <button id="submit">Envoyer en BDD</button>
    </div>

    <script>
        const qrSelect = document.getElementById('qr-select');
        const qrDisplay = document.getElementById('qr-display');
        let qrData = JSON.parse(localStorage.getItem('qrData')) || {};
        let qrIdCounter = Object.keys(qrData).length ? Math.max(...Object.keys(qrData).map(Number)) + 1 : 1;

        function generateQRCode(id, data) {
            const div = document.createElement('div');
            div.id = `qr-${id}`;
            div.classList.add('qr-item');
            new QRCode(div, {
                text: data,
                width: 128,
                height: 128
            });
            return div;
        }

        function updateQRCodeDisplay() {
            qrDisplay.innerHTML = "";
            const selectedValues = Array.from(qrSelect.selectedOptions).map(opt => opt.value);
            selectedValues.forEach(id => {
                if (qrData[id]) {
                    qrDisplay.appendChild(generateQRCode(id, qrData[id]));
                }
            });
        }

        function updateSelectOptions() {
            qrSelect.innerHTML = "";
            Object.keys(qrData).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.text = `QR Code ${id}`;
                qrSelect.add(option);
            });
        }

        document.getElementById('add-qr').addEventListener('click', function() {
            const newId = qrIdCounter++;
            qrData[newId] = `https://mon-site.com/velo/${newId}`;
            localStorage.setItem('qrData', JSON.stringify(qrData));
            updateSelectOptions();
        });

        document.getElementById('remove-qr').addEventListener('click', function() {
            const selectedOptions = Array.from(qrSelect.selectedOptions);
            if (selectedOptions.length === 0) {
                alert('Sélectionnez un QR Code à supprimer.');
                return;
            }
            selectedOptions.forEach(option => {
                delete qrData[option.value];
                option.remove();
            });
            localStorage.setItem('qrData', JSON.stringify(qrData));
            updateQRCodeDisplay();
        });

        document.getElementById('qr-select').addEventListener('change', updateQRCodeDisplay);

        document.getElementById('save').addEventListener('click', function() {
            localStorage.setItem('qrData', JSON.stringify(qrData));
            alert('QR Codes enregistrés localement.');
        });

        document.getElementById('submit').addEventListener('click', function() {
            const qrArray = Object.keys(qrData);
            if (qrArray.length === 0) {
                alert("Aucun QR Code à envoyer.");
                return;
            }
            fetch('/save_qr', { // Correction de la route pour correspondre au backend
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qrCodes: qrArray })
            })
            .then(res => res.json())
            .then(data => alert(data.success || data.error))
            .catch(err => console.error(err));
        });

        document.getElementById('print').addEventListener('click', function() {
            window.print();
        });

        // Restauration des QR codes au chargement
        updateSelectOptions();
    </script>
</body>
</html>